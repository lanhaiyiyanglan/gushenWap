var url=window.location.href;var groupid=url.split('?')[1].split('&')[0].split('=')[1];var userid=url.split('?')[1].split('&')[1].split('=')[1];var liveid=url.split('?')[1].split('&')[2].split('=')[1];var sdk=new WSDK();function x(tm) {    tm = parseInt(tm);    var date = new Date(tm); //转换成时间对象，这就简单了    var year = date.getFullYear();  //获取年    var mouth = date.getMonth() + 1 ;    var data = date.getDate();    var newdata=new Date();    var newyear=newdata.getFullYear();    var newmouth=newdata.getMonth()+1;    var newdate=newdata.getDate();    if((newyear+'-'+newmouth+'-'+newdate)==(year+'-'+mouth+'-'+data)){        if(date.getHours()<10){            hours='0'+date.getHours();        }else{            hours=date.getHours();        }        if(date.getMinutes()<10){            minute='0'+date.getMinutes();        }else{            minute=date.getMinutes();        }        return hours+':'+minute;    }else{        if (date.getMonth() < 10) {            mouth = '0' + (date.getMonth()+1);        } else {            data = date.getDate();        }        if(date.getDate()<10) {            data = '0' + date.getDate();        }else{            data = date.getDate();        }        return year+'-'+mouth+'-'+data;    }}$(window).scroll(function(){    if($(window).scrollTop()<10){        $('.preloader').show();    }else{        $('.preloader').hide();    }});$(document).ready(function() {    $('.title').children('li:nth-child(1)').click(function(){         window.location.href='graphicLive.html?uid='+userid+'&groupid='+groupid+'&liveid='+liveid;    })    sdk.Base.login({        uid: 'gs'+ $.cookie('user_id'),        appkey: '23316858',        credential: '111111',        timeout: 5000,        success: function (data) {            sdk.Base.startListenAllMsg();            sdk.Tribe.getTribeMembers({                tid:groupid,                success: function(data){                    console.log('获取群成员成功', data);                },                error: function(error){                    console.log('获取群成员失败', error);                }            });            nextkey = '';            sdk.Tribe.getHistory({                tid: groupid,                nextkey: nextkey,                count:1000,                success: function (data) {                    $.ajax({                        url:'http://open.zhengjuan.com/api/app',                        type:'POST',                        dataType:'jsonp',                        data:{                            module:'user',                            do:'getuserurl',                            user_id: $.cookie('user_id'),                            groupid:groupid                        },                        success:function(result){                            var html='';                            var length=data.data.msgs.length;                            for(var i=length-1;i>=0;i--){                                if( data.data.msgs[i].type==66){                                }else{                                    var length=result.data.length;                                    for(var n=0;n<length;n++){                                        if(data.data.msgs[i].from.substring(10)== $.cookie('user_id')&&data.data.msgs[i].from.substring(10)==result.data[n].uid){                                            html+='<div class="wkit-msg-wrap swiper-slide wkit-s"><div class="wkit-avatar-wrap"><img class="wkit-avatar" src="'+result.data[n].url+'"></div><div class="wkit-msg"><div class="wkit-msg-time"><span>'+x(data.data.msgs[i].time)+'</span><span style="color:#ffaf32;margin-left:2rem;">'+result.data[n].username+'</span></div><div class="wkit-msg-inner"><i class="wkit-arr"></i>';                                            if(data.data.msgs[i].type==0){                                                html+='<div class="wkit-msg-item">'+data.data.msgs[i].msg+'</div></div></div></div>';                                            }else if(data.data.msgs[i].type==1){                                                html+='<div class="wkit-msg-item"><img src="'+data.data.msgs[i].msg+'"></div></div></div></div>';                                            }else if(data.data.msgs[i].type==2){                                                html+='<div class="wkit-msg-item"><audio src="' + data.data.msgs[i].msg + '"  controls="controls"></audio></div></div></div></div>';                                            }                                        }else if(data.data.msgs[i].from.substring(10)!== $.cookie('user_id')&&data.data.msgs[i].from.substring(10)==result.data[n].uid){                                            html+='<div class="wkit-msg-wrap swiper-slide wkit-r"><div class="wkit-avatar-wrap notMe"><img class="wkit-avatar" src="'+result.data[n].url+'"></div><div class="wkit-msg notMe"><div class="wkit-msg-time"><span style="color:#ffaf32;margin-right:2rem;">'+result.data[n].username+'</span><span>'+x(data.data.msgs[i].time)+'</span></div><div class="wkit-msg-inner"><i class="wkit-arr"></i>';                                            if(data.data.msgs[i].type==0){                                                html+='<div class="wkit-msg-item">'+data.data.msgs[i].msg+'</div></div></div></div>';                                            }else if(data.data.msgs[i].type==1){                                                html+='<div class="wkit-msg-item"><img src="'+data.data.msgs[i].msg+'"></div></div></div></div>';                                            }else if(data.data.msgs[i].type==2){                                                html+='<div class="wkit-msg-item"><audio src="' + data.data.msgs[i].msg + '"  controls="controls"></audio></div></div></div></div>';                                            }                                        }                                    }                                }                            }                            $('.wkit-clear').append(html);                            $("body").scrollTop($("body")[0].scrollHeight);                        }                    })                    console.log(data);                    nextkey = data.data && data.data.next_key;//                        $('.preloader').click(function(){   这个是用来点击加载更多聊天记录的//                            if(nextkey!==''){////                            }//                        })                },                error: function (error) {                    console.log('获取历史消息失败', error);                }            });            console.log('login success', data);        },        error: function (error) {            // {code: 1002, resultText: 'TIMEOUT'}            console.log('login fail', error);        }    });    /*******监听新群消息开始***/    sdk.Event.on('TRIBE.MSG_RECEIVED', function(data){        $.ajax({            url: 'http://open.zhengjuan.com/api/app',            type: 'POST',            dataType: 'jsonp',            data: {                module: 'user',                do: 'getuserurl',                user_id: $.cookie('user_id'),                groupid: groupid            },            success:function(result){                var html='';                for(var i=data.data.msgs.length-1;i>=0;i--){                    for(var n=0;n<result.data.length;n++){                        if(data.data.msgs[i].from.substring(10)== $.cookie('user_id')&&data.data.msgs[i].from.substring(10)==result.data[n].uid){                            html+='<div class="wkit-msg-wrap wkit-s"><div class="wkit-avatar-wrap"><img class="wkit-avatar" src="'+result.data[n].url+'"></div><div class="wkit-msg"><div class="wkit-msg-time"><span>'+x(data.data.msgs[i].time)+'</span><span style="color:#ffaf32;margin-left:2rem;>'+result.data[n].username+'</span></div><div class="wkit-msg-inner"><i class="wkit-arr"></i>';                            if(data.data.msgs[i].type==0){                                html+='<div class="wkit-msg-item">'+data.data.msgs[i].msg+'</div></div></div></div>';                            }else if(data.data.msgs[i].type==1){                                html+='<div class="wkit-msg-item"><img src="'+data.data.msgs[i].msg+'"></div></div></div></div>';                            }else if(data.data.msgs[i].type==2){                                html+='<div class="wkit-msg-item"><audio src="' + data.data.msgs[i].msg + '"  controls="controls"></audio></div></div></div></div>';                            }                        }else if(data.data.msgs[i].from.substring(10)!== $.cookie('user_id')&&data.data.msgs[i].from.substring(10)==result.data[n].uid){                            html+='<div class="wkit-msg-wrap wkit-r"><div class="wkit-avatar-wrap notMe"><img class="wkit-avatar" src="'+result.data[n].url+'"></div><div class="wkit-msg notMe"><div class="wkit-msg-time"><span style="color:#ffaf32;margin-right:2rem;">'+result.data[n].username+'</span><span>'+x(data.data.msgs[i].time)+'</span></div><div class="wkit-msg-inner"><i class="wkit-arr"></i>';                            if(data.data.msgs[i].type==0){                                html+='<div class="wkit-msg-item">'+data.data.msgs[i].msg+'</div></div></div></div>';                            }else if(data.data.msgs[i].type==1){                                html+='<div class="wkit-msg-item"><img src="'+data.data.msgs[i].msg+'"></div></div></div></div>';                            }else if(data.data.msgs[i].type==2){                                html+='<div class="wkit-msg-item"><audio src="' + data.data.msgs[i].msg + '"  controls="controls"></audio></div></div></div></div>';                            }                        }                    }                }                $('.wkit-clear').append(html);                $("body").scrollTop($("body")[0].scrollHeight);            }        })    });    /*******监听新群消息开始***/})fileInput = document.getElementById('J_wKitImgUploader');fileInput.onchange = function(){    sdk.Plugin.Image.upload({        target: fileInput,        success: function(data){            image=data.data.url;            sdk.Tribe.sendMsg({                tid: groupid,                msg:data.data.url,                success: function(data){                    console.log(data)                    var html='';                    html+='<div class="wkit-msg-wrap swiper-slide wkit-s"><div class="wkit-avatar-wrap"><img class="wkit-avatar" src="'+ $.cookie("usericon")+'"></div><div class="wkit-msg"><div class="wkit-msg-time"><span>'+x(new Date().getTime())+'</span><span style="color:#ffaf32;margin-left:2rem;">'+ $.cookie("username")+'</span></div><div class="wkit-msg-inner"><i class="wkit-arr"></i>';                    html+='<div class="wkit-msg-item"><img src="'+image+'"></div></div></div></div>';                    $('.wkit-clear').append(html);                    $("body").scrollTop($("body")[0].scrollHeight);                },                error: function(error){                    console.log('发送群消息失败', error);                }            });        },        error: function(error){            console.log('上传失败', error);        }    });}$('#J_wkitSendBtn1').click(function(){    sdk.Tribe.sendMsg({        tid: groupid,        msg:$('#J_wkitTextarea').val(),        msgType:0,        success: function(data){            console.log(data)            var html='';            html+='<div class="wkit-msg-wrap wkit-s"><div class="wkit-avatar-wrap"><img class="wkit-avatar" src="'+ $.cookie('usericon')+'"></div><div class="wkit-msg"><div class="wkit-msg-time"><span>'+x(new Date().getTime())+'</span></div><div class="wkit-msg-inner"><i class="wkit-arr"></i><div class="wkit-msg-item">'+$('#J_wkitTextarea').val()+'</div></div></div></div>'            $('.wkit-clear').append(html);            $('#J_wkitTextarea').val('');            $("body").scrollTop($("body")[0].scrollHeight);        },        error: function(error){            console.log('发送群消息失败', error);        }    });})$(document).on('click','#gift li',function(){    $(this).children('div').addClass('get');    $('#gift li').not(this).children('div').removeClass('get');});$('.wkit-emot-trigger').click(function(){    window.location.href='../../hisIndex_killer/detailedInformation/getGift.html?groupid='+groupid+'&userid='+userid+'&liveid='+liveid;})